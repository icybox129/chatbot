name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.4.0

      - name: Terraform Init
        working-directory: infrastructure/environment/dev
        run: terraform init

      - name: Terraform Plan (ECR only)
        working-directory: infrastructure/environment/dev
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        run: terraform plan -target=module.ecr.aws_ecr_repository.ecr

      - name: Terraform Apply (ECR only)
        working-directory: infrastructure/environment/dev
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        run: terraform apply -auto-approve -target=module.ecr.aws_ecr_repository.ecr

      - name: Debug Terraform Output
        working-directory: infrastructure/environment/dev
        run: |
          # Retrieve the ECR URL directly
          ecr_repo_url=$(terraform output -raw ecr_repository_url || echo "")
          echo "Raw Terraform Output:"
          echo "$ecr_repo_url"
          echo "::remove-mask::$ecr_repo_url"
          echo "DEBUG: Unmasked ECR URL: $ecr_repo_url"

      - name: Clean and Validate ECR Repo URL
        working-directory: infrastructure/environment/dev
        run: |
          set -e
          # Retrieve the ECR URL
          ecr_repo_url=$(terraform output -raw ecr_repository_url || echo "")
          
          # Clean the value (remove newlines, carriage returns)
          ecr_repo_url=$(echo "$ecr_repo_url" | tr -d '\r\n')
          
          # Debugging
          echo "DEBUG: Cleaned ECR URL: $ecr_repo_url"

          # Validate it is not empty
          if [ -z "$ecr_repo_url" ]; then
            echo "::error::ECR Repository URL is empty or invalid"
            exit 1
          fi

          # Save to GitHub environment variable
          echo "ecr_repo_url=$ecr_repo_url" >> $GITHUB_ENV

      - name: Save ECR Repo URI as GitHub Actions Secret
        uses: gliech/create-github-secret-action@v1
        with:
          name: ECR_REPO_URL
          value: ${{ env.ecr_repo_url }}
          pa_token: ${{ secrets.GH_PA_TOKEN }}

      - name: Output ECR Repo Secret for Debugging
        run: |
            echo "::remove-mask::${{ secrets.ECR_REPO_URL }}"
            echo "DEBUG: ECR_REPO_URL is ${{ secrets.ECR_REPO_URL }}"
  
  


  # # --------------------------------------------------
  # # 3) Build and Push Docker Images
  # # --------------------------------------------------
  # build-and-push:
  #   name: Build & Push Docker Images
  #   runs-on: ubuntu-latest
  #   needs: get-ecr-uri
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v2
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: eu-west-2

  #     - name: Docker Login to ECR
  #       run: |
  #         aws ecr get-login-password --region eu-west-2 \
  #           | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO_URL }}

  #     - name: Build Backend Image
  #       run: |
  #         docker build -t chatbot-dev-chatbot:backend-latest -f Dockerfile.backend .
  #         docker tag chatbot-dev-chatbot:backend-latest \
  #           ${{ secrets.ECR_REPO_URL }}:backend-latest

  #     - name: Push Backend Image
  #       run: |
  #         docker push ${{ secrets.ECR_REPO_URL }}:backend-latest

  #     - name: Build Frontend Image
  #       run: |
  #         docker build -t chatbot-dev-chatbot:frontend-latest -f Dockerfile.frontend .
  #         docker tag chatbot-dev-chatbot:frontend-latest \
  #           ${{ secrets.ECR_REPO_URL }}:frontend-latest

  #     - name: Push Frontend Image
  #       run: |
  #         docker push ${{ secrets.ECR_REPO_URL }}:frontend-latest

  # # --------------------------------------------------
  # # 4) Deploy and Destroy Infrastructure (Terraform)
  # # --------------------------------------------------
  # deploy-and-clean:
  #   name: Deploy and Clean Up Infrastructure
  #   runs-on: ubuntu-latest
  #   needs: [build-and-push, create-ecr, get-ecr-uri] # Add create-ecr and get-ecr-uri here
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  
  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v2
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: eu-west-2
  
  #     - name: Set up Terraform
  #       uses: hashicorp/setup-terraform@v2
  #       with:
  #         terraform_version: 1.4.0
  
  #     - name: Terraform Apply
  #       working-directory: infrastructure/environment/dev
  #       env:
  #         TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
  #       run: terraform apply -auto-approve
  
  #     - name: Terraform Destroy
  #       if: always()  # Ensure destroy runs regardless of earlier failures
  #       working-directory: infrastructure/environment/dev
  #       env:
  #         TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
  #       run: terraform destroy -auto-approve
